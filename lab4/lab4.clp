;;;======================================================
;;;   Экспертная система диагностики автомобиля
;;;
;;;     Система диагностики основных проблем
;;;     автомобильного двигателя
;;;
;;;     Для CLIPS версии 6.3
;;;
;;;     Для запуска: загрузить, сбросить и запустить
;;;======================================================

;;****************
;;* ФУНКЦИИ ВВОДА *
;;****************

(deffunction задать-вопрос (?вопрос $?допустимые-значения)
   (printout t ?вопрос)
   (bind ?ответ (read))
   (if (lexemep ?ответ) 
       then (bind ?ответ (lowcase ?ответ)))
   (while (not (member ?ответ ?допустимые-значения)) do
      (printout t ?вопрос)
      (bind ?ответ (read))
      (if (lexemep ?ответ) 
          then (bind ?ответ (lowcase ?ответ))))
   ?ответ)

(deffunction да-или-нет (?вопрос)
   (bind ?ответ (задать-вопрос ?вопрос да нет д н y n))
   (if (or (eq ?ответ да) (eq ?ответ д) (eq ?ответ y))
       then да 
       else нет))

;;;***************
;;;* ПРАВИЛА ВОПРОСОВ *
;;;***************

(defrule определить-запуск-двигателя ""
   (not (двигатель-заводится ?))
   (not (рекомендация ?))
   =>
   (assert (двигатель-заводится (да-или-нет "Двигатель заводится (да/нет)? "))))
   
(defrule определить-нормальную-работу ""
   (двигатель-заводится да)
   (not (рекомендация ?))
   =>
   (assert (работает-нормально (да-или-нет "Двигатель работает нормально (да/нет)? "))))

(defrule определить-вращение-двигателя ""
   (двигатель-заводится нет)
   (not (рекомендация ?))   
   =>
   (assert (двигатель-вращается (да-или-нет "Двигатель вращается (прокручивается) при попытке запуска (да/нет)? "))))
   
(defrule определить-вялость ""
   (работает-нормально нет)
   (not (рекомендация ?))
   =>
   (assert (двигатель-вялый (да-или-нет "Двигатель работает вяло (да/нет)? "))))
   
(defrule определить-пропуски-зажигания ""
   (работает-нормально нет)
   (not (рекомендация ?))
   =>
   (assert (пропуски-зажигания (да-или-нет "Есть пропуски зажигания (двигатель троит) (да/нет)? "))))

(defrule определить-детонацию ""
   (работает-нормально нет)
   (not (рекомендация ?))
   =>
   (assert (детонация (да-или-нет "Слышна детонация (стук пальцев) (да/нет)? "))))

(defrule определить-потерю-мощности ""
   (работает-нормально нет)
   (not (рекомендация ?))
   =>
   (assert (потеря-мощности
               (да-или-нет "Заметна потеря мощности двигателя (да/нет)? "))))

(defrule определить-уровень-топлива ""
   (двигатель-заводится нет)
   (двигатель-вращается да)
   (not (рекомендация ?))
   =>
   (assert (топливо-в-баке
              (да-или-нет "В баке есть бензин (да/нет)? "))))

(defrule определить-заряд-аккумулятора ""
   (двигатель-вращается нет)
   (not (рекомендация ?))
   =>
   (assert (аккумулятор-заряжен
              (да-или-нет "Аккумулятор заряжен (да/нет)? "))))

(defrule определить-состояние-контактов ""
   (or (and (двигатель-заводится нет)      
            (двигатель-вращается да))
       (потеря-мощности да))
   (not (рекомендация ?))
   =>
   (assert (состояние-контактов
      (задать-вопрос "Какое состояние контактов трамблера (нормальное/обгоревшие/загрязненные)? "
                    нормальное обгоревшие загрязненные))))

(defrule проверить-катушку-зажигания ""
   (двигатель-заводится нет)      
   (двигатель-вращается нет)
   (аккумулятор-заряжен да)
   (not (рекомендация ?))
   =>
   (assert (тест-катушки
              (да-или-нет "Тест катушки зажигания положительный (да/нет)? "))))

;;;************************
;;;* ДОПОЛНИТЕЛЬНЫЕ ВОПРОСЫ *
;;;************************

(defrule определить-состояние-свечей ""
   (or (пропуски-зажигания да)
       (потеря-мощности да))
   (not (свечи-проверены ?))
   (not (рекомендация ?))
   =>
   (assert (свечи-проверены да))
   (assert (состояние-свечей 
               (задать-вопрос "Какое состояние свечей зажигания (нормальное/изношенные/загрязненные)? " 
                             нормальное изношенные загрязненные))))

(defrule определить-уровень-охлаждайки ""
   (or (детонация да)
       (перегрев (да-или-нет "Был ли перегрев двигателя (да/нет)? ")))
   (not (охлаждайка-проверена ?))
   (not (рекомендация ?))
   =>
   (assert (охлаждайка-проверена да))
   (assert (уровень-охлаждайки 
               (задать-вопрос "Какой уровень охлаждающей жидкости (нормальный/низкий/очень-низкий)? " 
                             нормальный низкий очень-низкий))))

(defrule определить-давление-топлива ""
   (or (двигатель-вялый да)
       (двигатель-заводится нет))
   (топливо-в-баке да)
   (not (давление-проверено ?))
   (not (рекомендация ?))
   =>
   (assert (давление-проверено да))
   (assert (давление-топлива 
               (задать-вопрос "Какое давление топлива (нормальное/низкое)? " 
                             нормальное низкое))))

;;;********************
;;;* ПРАВИЛА РЕМОНТА *
;;;********************

(defrule нормальная-работа ""
   (работает-нормально да)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Ремонт не требуется.")))

(defrule вялая-работа ""
   (двигатель-вялый да)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Прочистите топливную магистраль."))) 

(defrule пропуски-зажигания-ремонт ""
   (пропуски-зажигания да)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Отрегулируйте зазор контактов трамблера.")))     

(defrule детонация-ремонт ""
   (детонация да)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Отрегулируйте угол опережения зажигания.")))

(defrule нет-топлива ""
   (топливо-в-баке нет)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Залейте топливо в бак.")))

(defrule разряжен-аккумулятор ""
   (аккумулятор-заряжен нет)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Зарядите аккумулятор.")))

(defrule обгоревшие-контакты ""
   (состояние-контактов обгоревшие)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Замените контакты трамблера.")))

(defrule загрязненные-контакты ""
   (состояние-контактов загрязненные)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Очистите контакты трамблера.")))

(defrule катушка-исправна ""
   (тест-катушки да)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Отремонтируйте провод к распределителю.")))

(defrule катушка-неисправна ""
   (тест-катушки нет)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Замените катушку зажигания.")))

(defrule заменить-свечи ""
   (состояние-свечей изношенные)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Замените свечи зажигания.")))

(defrule очистить-или-заменить-свечи ""
   (состояние-свечей загрязненные)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Очистите или замените загрязненные свечи.")))

(defrule долить-охлаждайку ""
   (уровень-охлаждайки низкий)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Долейте охлаждающую жидкость до нормального уровня.")))

(defrule проверить-систему-охлаждения ""
   (уровень-охлаждайки очень-низкий)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Проверьте систему охлаждения на утечки и заправьте.")))

(defrule проверить-топливный-насос ""
   (давление-топлива низкое)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Проверьте топливный насос и топливный фильтр.")))

(defrule проверить-термостат ""
   (перегрев да)
   (уровень-охлаждайки нормальный)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Проверьте термостат и вентилятор радиатора.")))

;;;**************************
;;;* УГЛУБЛЕННАЯ ДИАГНОСТИКА *
;;;**************************

(defrule сложная-диагностика-пропусков ""
   (пропуски-зажигания да)
   (состояние-свечей нормальное)
   (not (рекомендация ?))
   =>
   (assert (проверить-компрессию (да-или-нет "Провести проверку компрессии (да/нет)? "))))

(defrule низкая-компрессия ""
   (проверить-компрессию да)
   (низкая-компрессия (да-или-нет "Компрессия низкая в одном или нескольких цилиндрах (да/нет)? "))
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Обнаружена механическая проблема двигателя. Требуется углубленная диагностика.")))

(defrule проверить-воздушный-фильтр ""
   (потеря-мощности да)
   (давление-топлива нормальное)
   (not (фильтр-проверен ?))
   (not (рекомендация ?))
   =>
   (assert (фильтр-проверен да))
   (assert (состояние-фильтра 
               (задать-вопрос "Какое состояние воздушного фильтра (чистый/грязный)? " 
                             чистый грязный))))

(defrule заменить-воздушный-фильтр ""
   (состояние-фильтра грязный)
   (not (рекомендация ?))
   =>
   (assert (рекомендация "Замените воздушный фильтр.")))

(defrule нет-рекомендаций ""
  (declare (salience -10))
  (not (рекомендация ?))
  =>
  (assert (рекомендация "Рекомендуем обратиться к автомеханику для диагностики.")))

;;;************************************
;;;* ЗАГРУЗОЧНЫЕ И ЗАКЛЮЧИТЕЛЬНЫЕ ПРАВИЛА *
;;;************************************

(defrule приветствие ""
  (declare (salience 10))
  =>
  (printout t crlf crlf)
  (printout t "Экспертная система диагностики автомобиля")
  (printout t crlf crlf))

(defrule вывести-рекомендацию ""
  (declare (salience 10))
  (рекомендация ?совет)
  =>
  (printout t crlf crlf)
  (printout t "Рекомендуемые действия:")
  (printout t crlf crlf)
  (format t " %s%n%n%n" ?совет))